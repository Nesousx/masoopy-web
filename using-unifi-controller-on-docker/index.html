<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Using Unifi controller on Docker |</title><meta name=Description content><meta property="og:title" content="Using Unifi controller on Docker"><meta property="og:description" content="Following a post on Reddit, I decided to share my config used to run the Unifi controller. Doing so, you won&rsquo;t have to purchase a Unifi Cloud Controller.
Spoiler alert&mldr; I no longer use Unifi hardware, and I&rsquo;ll share why in a future post.
System Overview I have 2 servers :
 local server at home, which runs the Unifi controller in a Docker swarm setup ; remote server online, which runs the NGiNX reverse proxy."><meta property="og:type" content="article"><meta property="og:url" content="https://www.masoopy.com/using-unifi-controller-on-docker/"><meta property="article:published_time" content="2018-11-10T18:04:27+01:00"><meta property="article:modified_time" content="2018-11-10T18:04:27+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Unifi controller on Docker"><meta name=twitter:description content="Following a post on Reddit, I decided to share my config used to run the Unifi controller. Doing so, you won&rsquo;t have to purchase a Unifi Cloud Controller.
Spoiler alert&mldr; I no longer use Unifi hardware, and I&rsquo;ll share why in a future post.
System Overview I have 2 servers :
 local server at home, which runs the Unifi controller in a Docker swarm setup ; remote server online, which runs the NGiNX reverse proxy."><meta name=application-name content="Masoopy"><meta name=apple-mobile-web-app-title content="Masoopy"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.masoopy.com/using-unifi-controller-on-docker/><link rel=prev href=https://www.masoopy.com/automatically-download-subtitles-with-plex/><link rel=next href=https://www.masoopy.com/watch-netflix-us-from-anywhere-in-the-world/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Using Unifi controller on Docker","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.masoopy.com\/using-unifi-controller-on-docker\/"},"genre":"posts","wordCount":707,"url":"https:\/\/www.masoopy.com\/using-unifi-controller-on-docker\/","datePublished":"2018-11-10T18:04:27+01:00","dateModified":"2018-11-10T18:04:27+01:00","publisher":{"@type":"Organization","name":"Author"},"author":{"@type":"Person","name":"Author"},"description":""}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Home","item":"https:\/\/www.masoopy.com\/"},{"@type":"ListItem","position":2,"name":"linux","item":"https://www.masoopy.com/categories/linux/"},{"@type":"ListItem","position":3,"name":"Using Unifi controller on Docker"}]}</script></head><body data-header-desktop data-header-mobile><script>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':(''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Masoopy class=header-logo>Masoopy</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Masoopy class=header-logo>Masoopy</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/>Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/categories/>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><main class=main><div class="container content-article theme-classic"><div class=toc id=toc-auto><div class=toc-title>Contents</div><div class=toc-content id=toc-content-auto></div></div><div class=header-post><div class=post-title><div class=post-all-meta><div class=breadcrumbs><a href=/>Home </a>/ <a href=/categories/linux/>linux </a>/ <a href=/>Using Unifi controller on Docker</a></div><h1 class="single-title animated flipInX">Using Unifi controller on Docker</h1><div class=post-meta><div class=post-meta-line><span class=post-category><a href=/categories/linux/><i class="far fa-folder fa-fw"></i>&nbsp;linux</a>
</span>&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time class=timeago datetime=2018-11-10>2018-11-10</time>&nbsp;&nbsp;&nbsp;&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;707 words
&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;4 minutes</div></div></div></div></div><article class="single toc-start"><div class="content-block content-block-first content-block-position"><div class=post><div class=image-theme-classic><img src=/images/2021/02/unifi.png style=width:100%></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#system-overview>System Overview</a></li><li><a href=#home-server>Home server</a></li><li><a href=#remote-server>Remote server</a></li><li><a href=#setting-up-nginx-virtual-host>Setting up nginx virtual host</a></li><li><a href=#getting-it-all-https>Getting it all httpS!</a></li></ul></li></ul></nav></div></div><p>Following a post on <a href=https://www.reddit.com/r/Ubiquiti/comments/9umu34/controller_w_dockercompose_nginx_reverseproxy/ target=_blank rel="noopener noreffer">Reddit</a>, I decided to share my config used to run the Unifi controller. Doing so, you won&rsquo;t have to purchase a <a href=https://amzn.to/2T2mLnS target=_blank rel="noopener noreffer">Unifi Cloud Controller</a>.</p><p>Spoiler alert&mldr; <a href=https://www.masoopy.com/all-your-devices-are-belong-to-ubiquity/ target=_blank rel="noopener noreffer">I no longer use Unifi hardware</a>, and I&rsquo;ll share why in a future post.</p><h3 id=system-overview>System Overview</h3><p>I have 2 servers :</p><ul><li>local server at home, which runs the Unifi controller in a Docker swarm setup ;</li><li>remote server online, which runs the NGiNX reverse proxy.</li></ul><p>The local server uses firewall rules (via PFSense) in order to filter incoming requests, so that it only accepts request from the remote server.</p><h3 id=home-server>Home server</h3><p>As explained above, my local server runs the Unifi server in Docker swarm &ldquo;mode&rdquo;, here is the config :</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>version: &#39;3&#39;

services:
  unifi:
    image: linuxserver/unifi
    deploy:
     replicas: 1
    hostname: unifi.domain.com
    ports:
      - &#34;3478:3478/udp&#34;
      - &#34;10001:10001/udp&#34;
      - &#34;8080:8080&#34;
      - &#34;8081:8081&#34;
      - &#34;8443:8443&#34;
      - &#34;8843:8843&#34;
      - &#34;8880:8880&#34;
      - &#34;6789:6789&#34;
    environment:
      - PUID=1000 
      - PGID=1000
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./config:/config
    networks:
     default:
         aliases:
          - unifi
</code></pre></div><p>As you can see, I expose quite a lot of ports, however they are almost all available only from my local network.</p><p>The only exception being the port 8443 that is open to my remote server (via PFSense firewall).</p><p>For more information about the Docker image, please check <a href=https://hub.docker.com/r/linuxserver/unifi/ target=_blank rel="noopener noreffer">their official page</a>.</p><h3 id=remote-server>Remote server</h3><p>For the nginx part, I do not use the <a href=https://hub.docker.com/r/jwilder/nginx-proxy/ target=_blank rel="noopener noreffer">jwilder version</a>, because as far as I know, it requires ports to be exposed.</p><p>I&rsquo;ll start by showing my container config. This is a docker-compose.yml file :</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>version: &#39;2&#39;

services:
  nginx:
    image: nginx
    container_name: nginx
    ports:
      - &#34;443:443&#34;
      - &#34;80:80&#34;
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./conf.d:/etc/nginx/conf.d
      - /etc/letsencrypt:/etc/nginx/ssl
      - /srv/data/ssl/dhparam.pem:/etc/nginx/cert/dhparam.pem
    restart: unless-stopped
    networks:
      default:
        aliases:
          - nginx

networks:
  default:
    external:
      name: br0
</code></pre></div><p>Let&rsquo;s explain a little bit what it does :</p><ul><li>I only expose ports 80 and 443 ;</li><li><a href=https://hub.docker.com/_/nginx/ target=_blank rel="noopener noreffer">The nginx (official)</a> image mounts volumes /etc/letsencrypt directory + <a href=https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html target=_blank rel="noopener noreffer">DH param</a> file from host as well, into my container and the conf.d directory (which holds my virtual hosts) ;</li><li>I create network aliases and separate networks for my &ldquo;group of apps&rdquo;.</li></ul><p>The network thing is very important. Remember, when I told you that I do not want to expose too many ports. Creating separate networks allow me to do so.</p><p>I have all my &ldquo;web&rdquo; apps, on the same network (br0, on this example). Which means, the reverse proxy can reach any other container by using its alias (even when containers&rsquo;s IP change). This is kind of Docker&rsquo;s internal DNS system.</p><p>I see two main benefits by not exposing the ports when my &ldquo;backend&rdquo; containers and my reverse proxy containers are running both on the same host  :</p><ol><li>I can use the same &ldquo;internal&rdquo; ports on all my backend containers (often 80 or 443);</li><li>I only expose 80 and 443 from my remote server to the rest of the world!</li></ol><h3 id=setting-up-nginx-virtual-host>Setting up nginx virtual host</h3><p>Now, that I have shared the reverse proxy container, let&rsquo;s see how it is connecting to my local computer.</p><p>This is a nginx vhost config which resides in ./conf.d (symlinked from ./conf.d/vhost) :</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>server {
       listen 80;
       server_name unifi.domain.com;
       return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    ssl_certificate /etc/nginx/ssl/live/domain.com/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/live/domain.com/privkey.pem;

    ssl_dhparam /etc/nginx/cert/dhparam.pem;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;

    add_header Strict-Transport-Security &#34;max-age=31536000; includeSubDomains&#34; always;

    server_name unifi.domain.com;
    access_log on;
    location / {
        proxy_pass https://domain.com:8443;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-for $remote_addr;
        port_in_redirect off;
        proxy_connect_timeout 300;
    }
}
</code></pre></div><p>As you can see, the proxy pass directive uses: <a href=https://domain.com>https://domain.com</a>:8443. Like I explained previously, domain.com points to my home server and port 8443 is only open from my remote server.</p><p>If the Unifi controller were running on the same host, then the proxy pass would point to the the network alias of that container without exposing any port. It would look something like below:</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>&amp;nbsp; &amp;nbsp;proxy_pass https://unifi:8443;
</code></pre></div><p>Finally, unifi.domain.com points to my remote server and force redirects to the httpS URL, using wildcard certs from Let&rsquo;s Encrypt.</p><h3 id=getting-it-all-https>Getting it all httpS!</h3><p>I generated my wildard certificate thanks to <a href=https://hub.docker.com/r/certbot/dns-cloudflare/ target=_blank rel="noopener noreffer">Let&rsquo;s Encrypt Docker image</a>.</p><p>Finally SSL certs are automagically renewed via a systemd &ldquo;job&rdquo; than runs the official letsencrypt container and renew my cert (wildcard), like below :</p><div class=highlight><pre class=chroma><code class=language-text data-lang=text>docker run -v /etc/letsencrypt/:/etc/letsencrypt/ certbot/dns-cloudflare renew --dns-cloudflare --email my@email.com --agree-tos --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini
</code></pre></div></div><div class=post><div class=post-info-share><span></span></div><div class=post-footer id=post-footer><div class=post-navigation><div class="post-nav-box nav-box-prev"><a class=nav-box href=/automatically-download-subtitles-with-plex/><span class=nav-icon><svg aria-hidden="true" data-prefix="fas" data-icon="chevron-circle-left" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 504C119 504 8 393 8 256S119 8 256 8s248 111 248 248-111 248-248 248zM142.1 273l135.5 135.5c9.4 9.4 24.6 9.4 33.9.0l17-17c9.4-9.4 9.4-24.6.0-33.9L226.9 256l101.6-101.6c9.4-9.4 9.4-24.6.0-33.9l-17-17c-9.4-9.4-24.6-9.4-33.9.0L142.1 239c-9.4 9.4-9.4 24.6.0 34z"/></svg></span><div style=text-align:right;padding-left:10px><div class=nav-text-h>Next article</div><span class=nav-text>Automatically download subtitles with Plex</span></div></a></div><div class="post-nav-box nav-box-next"><a class=nav-box href=/watch-netflix-us-from-anywhere-in-the-world/><div style=padding-right:10px><div class=nav-text-h>Next article</div><span class=nav-text>Watch Netflix US from anywhere in the world</span></div><span class=nav-icon><svg aria-hidden="true" data-prefix="fas" data-icon="chevron-circle-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8c137 0 248 111 248 248S393 504 256 504 8 393 8 256 119 8 256 8zm113.9 231L234.4 103.5c-9.4-9.4-24.6-9.4-33.9.0l-17 17c-9.4 9.4-9.4 24.6.0 33.9L285.1 256 183.5 357.6c-9.4 9.4-9.4 24.6.0 33.9l17 17c9.4 9.4 24.6 9.4 33.9.0L369.9 273c9.4-9.4 9.4-24.6.0-34z"/></svg></span></a></div></div></div></div></div><div id=toc-final></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.79.1">Hugo</a> | Theme - <a href="https://ublogger.netlify.app/?utm_source=https://www.masoopy.com/&utm_medium=footer&utm_campaign=config&utm_term=1.2.0" target=_blank title="uBlogger 1.2.0"><i class="fas fa-pencil-alt fa-fw"></i>uBlogger</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span>2021</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script src=/lib/smooth-scroll/smooth-scroll.min.js></script><script src=/lib/lazysizes/lazysizes.min.js></script><script src=/lib/clipboard/clipboard.min.js></script><script>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10}};</script><script src=/js/theme.min.js></script><script src=/js/jquery-3.5.1.min.js></script></body></html>