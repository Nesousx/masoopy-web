<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Using Unifi controller on Docker - Masoopy</title><meta name=Description content><meta property="og:title" content="Using Unifi controller on Docker"><meta property="og:description" content="Following a post on Reddit, I decided to share my config used to run the Unifi controller. Doing so, you won&rsquo;t have to purchase a Unifi Cloud Controller.
Spoiler alert&mldr; I no longer use Unifi hardware, and I&rsquo;ll share why in a future post.
System Overview I have 2 servers :
 local server at home, which runs the Unifi controller in a Docker swarm setup ; remote server online, which runs the NGiNX reverse proxy."><meta property="og:type" content="article"><meta property="og:url" content="https://www.masoopy.com/using-unifi-controller-on-docker/"><meta property="article:published_time" content="2018-11-10T18:04:27+01:00"><meta property="article:modified_time" content="2018-11-10T18:04:27+01:00"><meta property="og:site_name" content="Masoopy"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using Unifi controller on Docker"><meta name=twitter:description content="Following a post on Reddit, I decided to share my config used to run the Unifi controller. Doing so, you won&rsquo;t have to purchase a Unifi Cloud Controller.
Spoiler alert&mldr; I no longer use Unifi hardware, and I&rsquo;ll share why in a future post.
System Overview I have 2 servers :
 local server at home, which runs the Unifi controller in a Docker swarm setup ; remote server online, which runs the NGiNX reverse proxy."><meta name=application-name content="Masoopy"><meta name=apple-mobile-web-app-title content="Masoopy"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://www.masoopy.com/using-unifi-controller-on-docker/><link rel=prev href=https://www.masoopy.com/automatically-download-subtitles-with-plex/><link rel=next href=https://www.masoopy.com/watch-netflix-us-from-anywhere-in-the-world/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Using Unifi controller on Docker","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/www.masoopy.com\/using-unifi-controller-on-docker\/"},"genre":"posts","wordcount":789,"url":"https:\/\/www.masoopy.com\/using-unifi-controller-on-docker\/","datePublished":"2018-11-10T18:04:27+01:00","dateModified":"2018-11-10T18:04:27+01:00","publisher":{"@type":"Organization","name":"Denis G."},"author":{"@type":"Person","name":"Denis G."},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':(''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=Masoopy>Masoopy</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/cheatsheets/>Cheatsheets </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select id=language-select-desktop onchange="location=this.value;"><option value=/using-unifi-controller-on-docker/ selected>English</option></select>
</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=Masoopy>Masoopy</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/>Posts</a><a class=menu-item href=/cheatsheets/>Cheatsheets</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/categories/>Categories</a><a class=menu-item href=/about/>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a><a href=javascript:void(0); class=menu-item title="Select Language">English<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select onchange="location=this.value;"><option value=/using-unifi-controller-on-docker/ selected>English</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Using Unifi controller on Docker</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/about title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>Denis G.</a></span>&nbsp;<span class=post-category>included in <a href=/categories/linux/><i class="far fa-folder fa-fw"></i>linux</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2018-11-10>2018-11-10</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;789 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/2021/02/unifi.png data-srcset="/images/2021/02/unifi.png, /images/2021/02/unifi.png 1.5x, /images/2021/02/unifi.png 2x" data-sizes=auto alt=/images/2021/02/unifi.png title=/images/2021/02/unifi.png></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#system-overview>System Overview</a></li><li><a href=#home-server>Home server</a></li><li><a href=#remote-server>Remote server</a></li><li><a href=#setting-up-nginx-virtual-host>Setting up nginx virtual host</a></li><li><a href=#getting-it-all-https>Getting it all httpS!</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>Following a post on <a href=https://www.reddit.com/r/Ubiquiti/comments/9umu34/controller_w_dockercompose_nginx_reverseproxy/ target=_blank rel="noopener noreffer">Reddit</a>, I decided to share my config used to run the Unifi controller. Doing so, you won&rsquo;t have to purchase a <a href=https://amzn.to/2T2mLnS target=_blank rel="noopener noreffer">Unifi Cloud Controller</a>.</p><p>Spoiler alert&mldr; <a href=https://www.masoopy.com/all-your-devices-are-belong-to-ubiquity/ target=_blank rel="noopener noreffer">I no longer use Unifi hardware</a>, and I&rsquo;ll share why in a future post.</p><h3 id=system-overview>System Overview</h3><p>I have 2 servers :</p><ul><li>local server at home, which runs the Unifi controller in a Docker swarm setup ;</li><li>remote server online, which runs the NGiNX reverse proxy.</li></ul><p>The local server uses firewall rules (via PFSense) in order to filter incoming requests, so that it only accepts request from the remote server.</p><h3 id=home-server>Home server</h3><p>As explained above, my local server runs the Unifi server in Docker swarm &ldquo;mode&rdquo;, here is the config :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>version: &#39;3&#39;

services:
  unifi:
    image: linuxserver/unifi
    deploy:
     replicas: 1
    hostname: unifi.domain.com
    ports:
      - &#34;3478:3478/udp&#34;
      - &#34;10001:10001/udp&#34;
      - &#34;8080:8080&#34;
      - &#34;8081:8081&#34;
      - &#34;8443:8443&#34;
      - &#34;8843:8843&#34;
      - &#34;8880:8880&#34;
      - &#34;6789:6789&#34;
    environment:
      - PUID=1000 
      - PGID=1000
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./config:/config
    networks:
     default:
         aliases:
          - unifi
</code></pre></td></tr></table></div></div><p>As you can see, I expose quite a lot of ports, however they are almost all available only from my local network.</p><p>The only exception being the port 8443 that is open to my remote server (via PFSense firewall).</p><p>For more information about the Docker image, please check <a href=https://hub.docker.com/r/linuxserver/unifi/ target=_blank rel="noopener noreffer">their official page</a>.</p><h3 id=remote-server>Remote server</h3><p>For the nginx part, I do not use the <a href=https://hub.docker.com/r/jwilder/nginx-proxy/ target=_blank rel="noopener noreffer">jwilder version</a>, because as far as I know, it requires ports to be exposed.</p><p>I&rsquo;ll start by showing my container config. This is a docker-compose.yml file :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>version: &#39;2&#39;

services:
  nginx:
    image: nginx
    container_name: nginx
    ports:
      - &#34;443:443&#34;
      - &#34;80:80&#34;
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./conf.d:/etc/nginx/conf.d
      - /etc/letsencrypt:/etc/nginx/ssl
      - /srv/data/ssl/dhparam.pem:/etc/nginx/cert/dhparam.pem
    restart: unless-stopped
    networks:
      default:
        aliases:
          - nginx

networks:
  default:
    external:
      name: br0
</code></pre></td></tr></table></div></div><p>Let&rsquo;s explain a little bit what it does :</p><ul><li>I only expose ports 80 and 443 ;</li><li><a href=https://hub.docker.com/_/nginx/ target=_blank rel="noopener noreffer">The nginx (official)</a> image mounts volumes /etc/letsencrypt directory + <a href=https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html target=_blank rel="noopener noreffer">DH param</a> file from host as well, into my container and the conf.d directory (which holds my virtual hosts) ;</li><li>I create network aliases and separate networks for my &ldquo;group of apps&rdquo;.</li></ul><p>The network thing is very important. Remember, when I told you that I do not want to expose too many ports. Creating separate networks allow me to do so.</p><p>I have all my &ldquo;web&rdquo; apps, on the same network (br0, on this example). Which means, the reverse proxy can reach any other container by using its alias (even when containers&rsquo;s IP change). This is kind of Docker&rsquo;s internal DNS system.</p><p>I see two main benefits by not exposing the ports when my &ldquo;backend&rdquo; containers and my reverse proxy containers are running both on the same host  :</p><ol><li>I can use the same &ldquo;internal&rdquo; ports on all my backend containers (often 80 or 443);</li><li>I only expose 80 and 443 from my remote server to the rest of the world!</li></ol><h3 id=setting-up-nginx-virtual-host>Setting up nginx virtual host</h3><p>Now, that I have shared the reverse proxy container, let&rsquo;s see how it is connecting to my local computer.</p><p>This is a nginx vhost config which resides in ./conf.d (symlinked from ./conf.d/vhost) :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>server {
       listen 80;
       server_name unifi.domain.com;
       return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    ssl_certificate /etc/nginx/ssl/live/domain.com/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/live/domain.com/privkey.pem;

    ssl_dhparam /etc/nginx/cert/dhparam.pem;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;
    ssl_ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:ECDH+3DES:DH+3DES:RSA+AESGCM:RSA+AES:RSA+3DES:!aNULL:!MD5:!DSS;

    add_header Strict-Transport-Security &#34;max-age=31536000; includeSubDomains&#34; always;

    server_name unifi.domain.com;
    access_log on;
    location / {
        proxy_pass https://domain.com:8443;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-for $remote_addr;
        port_in_redirect off;
        proxy_connect_timeout 300;
    }
}
</code></pre></td></tr></table></div></div><p>As you can see, the proxy pass directive uses: <a href=https://domain.com>https://domain.com</a>:8443. Like I explained previously, domain.com points to my home server and port 8443 is only open from my remote server.</p><p>If the Unifi controller were running on the same host, then the proxy pass would point to the the network alias of that container without exposing any port. It would look something like below:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>&amp;nbsp; &amp;nbsp;proxy_pass https://unifi:8443;
</code></pre></td></tr></table></div></div><p>Finally, unifi.domain.com points to my remote server and force redirects to the httpS URL, using wildcard certs from Let&rsquo;s Encrypt.</p><h3 id=getting-it-all-https>Getting it all httpS!</h3><p>I generated my wildard certificate thanks to <a href=https://hub.docker.com/r/certbot/dns-cloudflare/ target=_blank rel="noopener noreffer">Let&rsquo;s Encrypt Docker image</a>.</p><p>Finally SSL certs are automagically renewed via a systemd &ldquo;job&rdquo; than runs the official letsencrypt container and renew my cert (wildcard), like below :</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-text data-lang=text>docker run -v /etc/letsencrypt/:/etc/letsencrypt/ certbot/dns-cloudflare renew --dns-cloudflare --email my@email.com --agree-tos --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini
</code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2018-11-10</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://www.masoopy.com/using-unifi-controller-on-docker/ data-title="Using Unifi controller on Docker" data-via=nesousx><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://www.masoopy.com/using-unifi-controller-on-docker/><i class="fab fa-linkedin fa-fw"></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://www.masoopy.com/using-unifi-controller-on-docker/ data-title="Using Unifi controller on Docker"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://www.masoopy.com/using-unifi-controller-on-docker/><i class="fab fa-reddit fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back();>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/automatically-download-subtitles-with-plex/ class=prev rel=prev title="Automatically download subtitles with Plex"><i class="fas fa-angle-left fa-fw"></i>Automatically download subtitles with Plex</a>
<a href=/watch-netflix-us-from-anywhere-in-the-world/ class=next rel=next title="Watch Netflix US from anywhere in the world">Watch Netflix US from anywhere in the world<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.79.1">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/about target=_blank>Denis G.</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>